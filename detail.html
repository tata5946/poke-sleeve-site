<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¾¡æ ¼æ¨ç§»</title>
  <meta name="description" content="ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ã®å¹´æ¬¡å¹³å‡ä¾¡æ ¼æ¨ç§»ã‚’æ²è¼‰ã€‚éå»ã®ç›¸å ´å¤‰å‹•ã‚’ç¢ºèªã§ãã¾ã™ã€‚">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 40px; }
    a { color: #0b57d0; }
    .meta { color:#666; margin-top:6px; }
    .wrap { max-width: 900px; margin: 0 auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <p><a href="./index.html">â† ä¸€è¦§ã«æˆ»ã‚‹</a></p>

    <h1 id="name">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>
    <p>
æœ¬ãƒšãƒ¼ã‚¸ã§ã¯ã€æœªé–‹å°çŠ¶æ…‹ã®ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ã®å¹´æ¬¡å¹³å‡ä¾¡æ ¼æ¨ç§»ã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
éå»ã®ç›¸å ´å¤‰å‹•ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€ç¾åœ¨ã®å¸‚å ´å‚¾å‘ã‚„ä¾¡æ ¼ã®æ¨ç§»ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚
ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚„å£²è²·åˆ¤æ–­ã®å‚è€ƒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚
    </p>
    <div id="meta" class="meta"></div>

    <div id="stats" style="border:1px solid #ddd; border-radius:10px; padding:12px; margin: 14px 0;">
  èª­ã¿è¾¼ã¿ä¸­â€¦
</div>

<p style="margin: 10px 0;">
  <a href="./ranking.html">ğŸ“ˆ ä¾¡æ ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a> /
  <a href="./surge.html">ğŸš€ æ€¥ä¸Šæ˜‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a> /
  <a href="./growth.html">ğŸ”¥ é«˜é¨°ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
</p>
    
    <h2>å¹´æ¬¡å¹³å‡ä¾¡æ ¼æ¨ç§»</h2>
    <canvas id="priceChart" height="120"></canvas>
    <p style="font-size:12px; color:#666; margin-top:8px;">
æœ€çµ‚æ›´æ–°æ—¥ï¼š2026å¹´2æœˆæ›´æ–°
</p>
  </div>

 <script>
  function getId() {
    const params = new URLSearchParams(location.search);
    return params.get("id");
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function main() {
    try {
      const id = getId();
      if (!id) {
        document.getElementById("name").textContent = "IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
        return;
      }

      const res = await fetch("./data.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("data.json ã®å–å¾—ã«å¤±æ•—: HTTP " + res.status);
      const data = await res.json();

      const s = (data.sleeves || []).find(x => x.id === id);
      if (!s) {
        document.getElementById("name").textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
        return;
      }

      document.title = `${s.name}ï½œä¾¡æ ¼æ¨ç§»`;
      document.getElementById("name").textContent = s.name;
      document.getElementById("meta").textContent = `ç™ºå£²å¹´ï¼š${escapeHtml(s.releaseYear ?? "")} / ${escapeHtml(s.condition ?? "")} / ${escapeHtml(s.series ?? "")}`;

      // years ã‚’æ•°å€¤ã§ã‚½ãƒ¼ãƒˆã—ã¦æ–‡å­—åˆ—é…åˆ—ã«æˆ»ã™ï¼ˆå®‰å…¨ï¼‰
      const rawYears = Object.keys(s.pricesByYear || {});
      const yearsNum = rawYears.map(y => Number(y)).filter(Number.isFinite).sort((a,b) => a - b);
      const years = yearsNum.map(String);

      // prices ã‚’å®‰å…¨ã«ä½œã‚‹
      const prices = years.map(y => {
        const v = s.pricesByYear[y];
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      });

      const statsEl = document.getElementById("stats");
      // å¹´ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (years.length === 0 || prices.every(p => p == null)) {
        statsEl.innerHTML = "ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
        // ã‚°ãƒ©ãƒ•ã‚’ç©ºã«ã™ã‚‹ï¼ˆæ—¢ã«æç”»æ¸ˆã¿ã®å ´åˆã«å‚™ãˆã€canvasã‚’ã‚¯ãƒªã‚¢ï¼‰
        const ctx = document.getElementById("priceChart").getContext && document.getElementById("priceChart").getContext('2d');
        // â€» Chart.js ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã¯åˆ¥é€”destroyãŒå¿…è¦ï¼ˆä»Šå›ã¯å˜ç™ºæç”»ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      } else {
        const latestYear = years[years.length - 1];
        const latestPriceRaw = s.pricesByYear[latestYear];
        const latestPrice = Number(latestPriceRaw);

        // è¡¨ç¤ºç”¨ã«å®‰å…¨ã«format
        const fmt = (n) => Number.isFinite(n) ? n.toLocaleString() + "å††" : "ãƒ‡ãƒ¼ã‚¿ãªã—";

        let statsHtml = `æœ€æ–°ï¼ˆ${escapeHtml(latestYear)}ï¼‰ï¼š${fmt(latestPrice)}`;

        if (years.length >= 2) {
          const prevYear = years[years.length - 2];
          const prevPrice = Number(s.pricesByYear[prevYear]);
          if (Number.isFinite(prevPrice) && Number.isFinite(latestPrice) && prevPrice !== 0) {
            const diff = latestPrice - prevPrice;
            const pct = (diff / prevPrice) * 100;
            statsHtml += `<br>å‰å¹´å·®ï¼ˆ${escapeHtml(prevYear)}â†’${escapeHtml(latestYear)}ï¼‰ï¼š${diff.toLocaleString()}å††`;
            statsHtml += `<br>ä¸Šæ˜‡ç‡ï¼š${pct.toFixed(1)}%`;
          } else {
            statsHtml += `<br>å‰å¹´å·®/ä¸Šæ˜‡ç‡ï¼šãƒ‡ãƒ¼ã‚¿ä¸è¶³ã¾ãŸã¯å‰å¹´ä¾¡æ ¼ãŒ0ã§ã™`;
          }
        } else {
          statsHtml += `<br>å‰å¹´å·®/ä¸Šæ˜‡ç‡ï¼šãƒ‡ãƒ¼ã‚¿ä¸è¶³`;
        }

        statsEl.innerHTML = statsHtml;
      }

      // Chart æç”»ï¼ˆprices ã® null ã‚’æ‰±ã†ãŸã‚ã€null ã‚’ 0 ã«ã›ãšã«ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦æç”»ã™ã‚‹æ–¹æ³•ã‚’ã¨ã‚‹ï¼‰
      // chartLabels ã¨ chartData ã‚’ prices ã® null ã‚’é™¤å¤–ã—ã¤ã¤å¯¾å¿œã™ã‚‹ year ã‚’æ®‹ã™
      const chartLabels = [];
      const chartData = [];
      for (let i = 0; i < years.length; i++) {
        const p = prices[i];
        if (p == null) continue;
        chartLabels.push(years[i]);
        chartData.push(p);
      }

      // æç”»å‰ã«æ—¢å­˜ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå˜ç´”ã«ä¸Šæ›¸ãã§OKï¼‰
      const ctxEl = document.getElementById("priceChart");
      // æ—¢ã« Chart ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆã¯ç ´æ£„ã—ãŸã»ã†ãŒå®‰å…¨ã ãŒã€ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ã®ãŸã‚å†æç”»ã§ä¸Šæ›¸ã
      new Chart(ctxEl, {
        type: "line",
        data: {
          labels: chartLabels,
          datasets: [{
            label: "å¹³å‡ä¾¡æ ¼ï¼ˆå††ï¼‰",
            data: chartData,
            borderWidth: 2,
            tension: 0.2
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    } catch (err) {
      console.error("detail page error:", err);
      // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ #stats ã«å‡ºã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã«ã‚‚åˆ†ã‹ã‚‹ã‚ˆã†ã«ï¼‰
      const statsEl = document.getElementById("stats");
      if (statsEl) statsEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆConsole ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    }
  }

  main();
</script>
</body>
</html>
