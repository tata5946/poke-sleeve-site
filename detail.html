<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>スリーブ詳細｜ポケスリ相場ナビ</title>
  <meta name="description" content="ポケカスリーブの価格推移（週次・年次）を表示します。" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f9ff;
      --card:#ffffff;
      --text:#111;
      --muted:#667085;
      --border:#e6e8ef;
      --shadow: 0 6px 18px rgba(16,24,40,.06);
      --radius:14px;
      --accent:#1e5bd7;
      --accent2:#ffcc00;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      margin:0;
      background:linear-gradient(180deg,#f7fbff 0%, #f5f9ff 100%);
      color:var(--text);
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .container{ max-width:1100px; margin:0 auto; padding:20px; }

    /* header */
    .header{
      position: sticky;
      top:0;
      z-index:50;
      background: rgba(245,249,255,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding:14px 20px;
      max-width:1100px;
      margin:0 auto;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 260px;
      text-decoration:none;
      color:inherit;
    }
    .brand:hover{ text-decoration:none; }

    .logo{
      width:38px; height:38px; border-radius:999px;
      background: linear-gradient(#e53935 0 50%, #ffffff 50% 100%);
      border: 2px solid #111;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      flex: 0 0 auto;
    }
    .logo::before{
      content:"";
      position:absolute;
      left:0; right:0; top:50%;
      height:3px;
      background:#111;
      transform: translateY(-50%);
    }
    .logo::after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:12px; height:12px;
      border-radius:999px;
      background:#fff;
      border:2px solid #111;
      transform: translate(-50%,-50%);
    }

    .main-title{
      font-size:28px;
      font-weight:900;
      letter-spacing:0.8px;
      margin:0;
      line-height:1.1;
      color:#7aa8ff;
      white-space: nowrap;
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, "Segoe UI", sans-serif;
      text-shadow: 0 2px 0 rgba(255, 204, 0, .35);
    }
    .accent{ color: var(--accent2); }
    .sub-title{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.3;
    }

    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .nav a{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #d0dcff;
      background:#f0f5ff;
      color:var(--accent);
      font-weight:700;
      font-size:13px;
    }
    .nav a:hover{
      background:#dbe6ff;
      text-decoration:none;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }

    .error{
      background:#fff3f3;
      border:1px solid #ffcccc;
      padding:12px;
      border-radius:12px;
      color:#b00020;
      display:none;
      margin: 14px 0;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .main-title{ font-size:20px; }
    }

    .hero{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .hero{ grid-template-columns: 1fr; }
    }

    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      display:block;
    }

    .name{
      font-size:22px;
      font-weight:900;
      margin:0 0 6px;
    }
    .meta{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .badges{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px; }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #ffe082;
      background:#fff8cc;
      color:#5c4b00;
      font-weight:800;
    }

    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .kpi .box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      min-width: 220px;
    }
    .kpi .label{ font-size:11px; color:var(--muted); font-weight:800; }
    .kpi .value{ font-size:18px; font-weight:900; margin-top:4px; }

    .delta{
      margin-top:6px;
      font-size:12px;
      font-weight:900;
    }
    .up{ color:#d32f2f; }
    .down{ color:#1976d2; }
    .flat{ color:#667085; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align: top;
    }
    th{
      background:#f6f8ff;
      font-weight:900;
      color:#111;
      white-space: nowrap;
    }
    tr:last-child td{ border-bottom:none; }

    .btn{
      display:inline-block;
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      font-weight:800;
    }
    .btn:hover{ background:#f2f4f7; text-decoration:none; }

    /* charts */
    .chart-wrap{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px;
      margin-bottom:10px;
      position: relative;
    }
    .chart-title{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin:0 0 6px;
    }
    .chart-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }
    svg.chart{
      width:100%;
      height:auto;
      display:block;
    }
    .chart-tooltip{
      position:absolute;
      display:none;
      pointer-events:none;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e6e8ef;
      background:#fff;
      font-size:12px;
      font-weight:800;
      color:#111;
      box-shadow:0 8px 18px rgba(16,24,40,.10);
      transform: translate(-50%, -110%);
      z-index: 5;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-inner">
      <a href="./index.html" class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 class="main-title"><span class="accent">ポケスリ</span>相場ナビ</h1>
          <div class="sub-title">ポケカスリーブ価格推移データベース</div>
        </div>
      </a>

      <nav class="nav" aria-label="メインメニュー">
        <a href="./index.html">一覧</a>
        <a href="./ranking.html">価格ランキング</a>
        <a href="./growth.html">高騰率</a>
        <a href="./surge.html">急上昇</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div id="error" class="error"></div>

    <div class="hero">
      <div class="panel">
        <img id="img" class="thumb" alt="" />
      </div>

      <div class="panel">
        <h2 id="name" class="name">読み込み中…</h2>
        <div id="meta" class="meta"></div>

        <div id="badges" class="badges"></div>

        <div class="kpi">
          <div class="box">
            <div class="label">最新週次価格</div>
            <div id="latestWeekly" class="value">—</div>
            <div id="weeklyDelta" class="delta"></div>
            <div id="weeklyCount" class="meta" style="margin-top:6px;">取引件数：—</div>
          </div>
        </div>

        <a class="btn" href="./index.html">← 一覧へ戻る</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3 style="margin:0 0 10px;">週次価格（weekly）</h3>
        <div id="weeklyChart"></div>
        <div id="weeklyTable"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 10px;">年次価格（yearly）</h3>
        <div id="yearlyChart"></div>
        <div id="yearlyTable"></div>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyl-TAhWBEVIgilTDv7lwS14T3_i9z57dUX4fqUVBS9gyr1EO7SaYy3aqP0V1gZtt6z/exec";

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showError(msg) {
      const el = document.getElementById("error");
      el.style.display = "block";
      el.textContent = msg;
    }

    function getParam(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    async function loadData() {
      const res = await fetch(GAS_URL + "?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(`データ取得に失敗しました（HTTP ${res.status}）`);
      return await res.json();
    }

    function toISODate(d) {
      const dd = new Date(d);
      if (Number.isNaN(dd.getTime())) return null;
      const y = dd.getFullYear();
      const m = String(dd.getMonth() + 1).padStart(2, "0");
      const day = String(dd.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatPeriodLabel(iso) {
      const s = String(iso || "").trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return s;

      const y = m[1];
      const mo = m[2];
      const d = m[3];

      if (mo === "01" && d === "01") return `${y}年`;
      if (d === "01") return `${y}年${Number(mo)}月`;
      return `${y}/${mo}/${d}`;
    }

    // weeklyPrices: [{week, price, count}]
    function normalizeWeekly(arr) {
      return (Array.isArray(arr) ? arr : [])
        .map(x => {
          const week = toISODate(x.week);

          // priceを安全にパース
          let price = null;
          const priceStr = String(x.price ?? "").trim();
          if (priceStr !== "" && priceStr !== "-" && priceStr !== "—") {
            const n = Number(priceStr);
            if (Number.isFinite(n)) price = n;
          }

          // countを安全にパース
          let count = null;
          const countStr = String(x.count ?? "").trim();
          if (countStr !== "" && countStr !== "-" && countStr !== "—") {
            const n = Number(countStr);
            if (Number.isFinite(n)) count = n;
          }

          // 取引なし週：count===0 または price===null
          const noTrades = (count === 0) || (price === null);

          return {
            week,
            price: noTrades ? null : price,
            count: count
          };
        })
        .filter(x => x.week)
        .sort((a, b) => String(a.week).localeCompare(String(b.week))); // asc
    }

    function latestTwoTradedWeeks(rows) {
      const traded = (Array.isArray(rows) ? rows : []).filter(r => Number.isFinite(r.price));
      if (traded.length === 0) return null;

      const uniq = [];
      const seen = new Set();
      for (let i = traded.length - 1; i >= 0; i--) {
        if (seen.has(traded[i].week)) continue;
        seen.add(traded[i].week);
        uniq.push(traded[i]);
        if (uniq.length === 2) break;
      }
      return { latest: uniq[0], prev: uniq[1] || null };
    }

    function normalizeYearly(obj) {
      const o = obj && typeof obj === "object" ? obj : {};
      return Object.keys(o)
        .map(y => ({ year: String(y), price: Number(o[y]) }))
        .filter(x => x.year && Number.isFinite(x.price))
        .sort((a, b) => String(a.year).localeCompare(String(b.year))); // asc
    }

    function renderTableWeekly(rows) {
      if (!rows.length) return `<div class="meta">週次データがまだありません</div>`;

      const hasCount = rows.some(r => Number.isFinite(r.count));

      const html = rows.slice().reverse().map(r => {
        const priceCell = Number.isFinite(r.price) ? `${Number(r.price).toLocaleString()}円` : "—";
        const countCell = hasCount ? `<td>${Number.isFinite(r.count) ? `${r.count}件` : "—"}</td>` : "";
        return `<tr><td>${escapeHtml(formatPeriodLabel(r.week))}</td><td>${priceCell}</td>${countCell}</tr>`;
      }).join("");

      const headCount = hasCount ? `<th>件数</th>` : "";

      return `
        <table>
          <thead><tr><th>期間</th><th>価格</th>${headCount}</tr></thead>
          <tbody>${html}</tbody>
        </table>
      `;
    }

    function renderTableYearly(rows) {
      if (!rows.length) return `<div class="meta">年次データがまだありません</div>`;
      const html = rows.slice().reverse().map(r =>
        `<tr><td>${escapeHtml(r.year)}</td><td>${Number(r.price).toLocaleString()}円</td></tr>`
      ).join("");
      return `
        <table>
          <thead><tr><th>年</th><th>価格</th></tr></thead>
          <tbody>${html}</tbody>
        </table>
      `;
    }

    function setWeeklyKpi(weeklyRows) {
      const latestEl = document.getElementById("latestWeekly");
      const deltaEl = document.getElementById("weeklyDelta");
      const countEl = document.getElementById("weeklyCount");

      const pair = latestTwoTradedWeeks(weeklyRows);

      if (!pair) {
        latestEl.textContent = "—";
        deltaEl.textContent = "直近の取引なし";
        deltaEl.className = "delta flat";
        countEl.textContent = "取引件数：—";
        return;
      }

      latestEl.textContent = `${pair.latest.price.toLocaleString()}円`;

      const cnt = Number.isFinite(pair.latest.count) ? pair.latest.count : null;
      countEl.textContent = `取引件数：${cnt != null ? `${cnt}件` : "—"}`;

      if (!pair.prev) {
        deltaEl.textContent = "比較できる前週データなし";
        deltaEl.className = "delta flat";
        return;
      }

      const diff = pair.latest.price - pair.prev.price;
      const abs = Math.abs(diff);
      let cls = "flat";
      let arrow = "→";
      let sign = "±";
      if (diff > 0) { cls = "up"; arrow = "↑"; sign = "+"; }
      if (diff < 0) { cls = "down"; arrow = "↓"; sign = "−"; }

      let pct = "";
      if (pair.prev.price !== 0) {
        const rate = (diff / pair.prev.price) * 100;
        if (Number.isFinite(rate)) {
          pct = `（${diff > 0 ? "+" : diff < 0 ? "-" : ""}${Math.abs(rate).toFixed(1)}%）`;
        }
      }

      deltaEl.className = "delta " + cls;
      deltaEl.textContent = `${arrow} 前回取引週比 ${sign}${abs.toLocaleString()}円 ${pct}`;
    }

    // ---------- renderLineChart（統合版） ----------
    function renderLineChart(containerId, title, rows, xKey, yKey, options = {}) {
      const el = document.getElementById(containerId);
      if (!el) return;

      // data: filter out null prices so weeks with no trades are excluded from plot
      const data = (Array.isArray(rows) ? rows : [])
        .map(r => {
          const x = String(r?.[xKey] ?? "");
          const rawY = r?.[yKey];
          let y = null;
          if (rawY !== null && rawY !== undefined && rawY !== "" && rawY !== "-" && rawY !== "—") {
            const n = Number(rawY);
            if (Number.isFinite(n)) y = n;
          }
          return { x, y };
        })
        .filter(p => p.x && Number.isFinite(p.y));

      if (data.length < 2) {
        el.innerHTML = `<div class="chart-wrap"><div class="chart-title">${escapeHtml(title)}</div><div class="meta">データが不足しています</div></div>`;
        return;
      }

      const W = 760;
      const H = 240;
      const padL = 60, padR = 20, padT = 20, padB = 40;
      const ticks = 4;

      const ys = data.map(d => d.y);
      let yMin = Math.min(...ys);
      let yMax = Math.max(...ys);

      const margin = (yMax - yMin) * 0.1 || 1;
      yMin -= margin;
      yMax += margin;

      function niceStep(range, t) {
        const rough = range / t;
        const pow = Math.pow(10, Math.floor(Math.log10(Math.max(rough, 1))));
        const candidates = [1, 2, 5, 10].map(m => m * pow);
        return candidates.reduce((best, v) =>
          Math.abs(v - rough) < Math.abs(best - rough) ? v : best
        , candidates[0]);
      }

      const step = niceStep(yMax - yMin, ticks);
      yMin = Math.floor(yMin / step) * step;
      yMax = Math.ceil(yMax / step) * step;

      const xToPx = (i) => padL + (i / (data.length - 1)) * (W - padL - padR);
      const yToPx = (v) => padT + (1 - (v - yMin) / (yMax - yMin)) * (H - padT - padB);

      const pathD = data.map((p, i) =>
        `${i === 0 ? "M" : "L"} ${xToPx(i)} ${yToPx(p.y)}`
      ).join(" ");

      const tickLines = [];
      const tickLabels = [];
      for (let i = 0; i <= ticks; i++) {
        const v = yMin + (i / ticks) * (yMax - yMin);
        const y = yToPx(v);
        tickLines.push(`<line x1="${padL}" y1="${y}" x2="${W - padR}" y2="${y}" stroke="#e6e8ef"/>`);
        tickLabels.push(
          `<text x="${padL - 12}" y="${y + 4}" text-anchor="end" font-size="12" fill="#475467" font-weight="700">${Math.round(v).toLocaleString()}</text>`
        );
      }

      const xFirst = formatPeriodLabel(data[0].x);
      const xLast  = formatPeriodLabel(data[data.length - 1].x);

      const lastIdx = data.length - 1;
      const lastX = xToPx(lastIdx);
      const lastY = yToPx(data[lastIdx].y);
      const lastLabel = `${data[lastIdx].y.toLocaleString()}円`;

      el.innerHTML = `
        <div class="chart-wrap">
          <div class="chart-title">${escapeHtml(title)}</div>
          <div class="chart-tooltip"></div>

          <svg class="chart" viewBox="0 0 ${W} ${H}">
            <defs>
              <linearGradient id="bgGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#1e5bd7" stop-opacity="0.08"/>
                <stop offset="100%" stop-color="#1e5bd7" stop-opacity="0"/>
              </linearGradient>
            </defs>

            ${tickLines.join("")}
            ${tickLabels.join("")}

            <rect x="${padL}" y="${padT}" width="${W - padL - padR}" height="${H - padT - padB}" fill="url(#bgGrad)" />

            <path d="${pathD}" fill="none" stroke="#1e5bd7" stroke-width="3" stroke-dasharray="6 6" stroke-linecap="round"/>

            <line class="hover-line" y1="${padT}" y2="${H - padB}" stroke="#94a3b8" stroke-width="1" style="display:none;" />
            <circle class="hover-dot" r="5" fill="#1e5bd7" style="display:none;" />

            <rect class="hover-hit" x="${padL}" y="${padT}" width="${W - padL - padR}" height="${H - padT - padB}" fill="transparent"/>

            <circle cx="${lastX}" cy="${lastY}" r="5" fill="#1e5bd7"/>
            <text x="${lastX + 8}" y="${lastY - 8}" font-size="12" font-weight="800" fill="#111">${escapeHtml(lastLabel)}</text>

            <text x="${padL}" y="${H - 10}" font-size="14" fill="#667085">${escapeHtml(xFirst)}</text>
            <text x="${W - padR}" y="${H - 10}" font-size="14" fill="#667085" text-anchor="end">${escapeHtml(xLast)}</text>
          </svg>
        </div>
      `;

      // hover interactions
      const wrap = el.querySelector(".chart-wrap");
      const svg = el.querySelector("svg.chart");
      const tip = el.querySelector(".chart-tooltip");
      const hit = el.querySelector(".hover-hit");
      const hLine = el.querySelector(".hover-line");
      const hDot = el.querySelector(".hover-dot");

      hit.addEventListener("mousemove", (ev) => {
        const rect = svg.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const vbX = (x / rect.width) * W;
        const t = (vbX - padL) / (W - padL - padR);
        const idx = Math.round(t * (data.length - 1));
        const safeIdx = Math.max(0, Math.min(data.length - 1, idx));

        const px = xToPx(safeIdx);
        const py = yToPx(data[safeIdx].y);

        hLine.style.display = "block";
        hDot.style.display = "block";
        tip.style.display = "block";

        hLine.setAttribute("x1", px);
        hLine.setAttribute("x2", px);
        hLine.setAttribute("y1", padT);
        hLine.setAttribute("y2", H - padB);
        hDot.setAttribute("cx", px);
        hDot.setAttribute("cy", py);

        tip.textContent = `${formatPeriodLabel(data[safeIdx].x)}：${data[safeIdx].y.toLocaleString()}円`;
        const wrapRect = wrap.getBoundingClientRect();
        tip.style.left = `${Math.min(Math.max(ev.clientX - wrapRect.left, 40), wrapRect.width - 40)}px`;
        tip.style.top  = `${Math.max(ev.clientY - wrapRect.top - 12, 8)}px`;
      });

      hit.addEventListener("mouseleave", () => {
        hLine.style.display = "none";
        hDot.style.display = "none";
        tip.style.display = "none";
      });
    }
    // ---------- end renderLineChart ----------

    async function main() {
      const id = getParam("id");
      if (!id) { showError("id が指定されていません。indexから入り直してください。"); return; }

      let data;
      try { data = await loadData(); }
      catch (e) { showError(e.message); return; }

      const sleeves = Array.isArray(data.sleeves) ? data.sleeves : [];
      const s = sleeves.find(x => String(x.id) === String(id));
      if (!s) { showError("該当スリーブが見つかりませんでした。"); return; }

      document.title = `${s.name || "スリーブ詳細"}｜ポケスリ相場ナビ`;

      const img = document.getElementById("img");
      img.referrerPolicy = "no-referrer";
      img.src = String(s.imageUrl || "").trim();
      img.alt = s.name || "";

      document.getElementById("name").textContent = s.name || "";
      document.getElementById("meta").innerHTML =
        `発売年：${escapeHtml(s.releaseYear)} / シリーズ：${escapeHtml(s.series)} / 状態：${escapeHtml(s.condition)}`;

      document.getElementById("badges").innerHTML = `
        <span class="badge">発売年：${escapeHtml(s.releaseYear)}</span>
        <span class="badge">${escapeHtml(s.condition)}</span>
        <span class="badge">${escapeHtml(s.series)}</span>
      `;

      // weekly
      const weeklyRows = normalizeWeekly(s.weeklyPrices);
      renderLineChart("weeklyChart", "週次価格 推移", weeklyRows, "week", "price", { height: 240 });
      document.getElementById("weeklyTable").innerHTML = renderTableWeekly(weeklyRows);
      setWeeklyKpi(weeklyRows);

      // yearly（推移だけ）
      const yearlyRows = normalizeYearly(s.pricesByYear);
      renderLineChart("yearlyChart", "年次価格 推移", yearlyRows, "year", "price", { height: 240 });
      document.getElementById("yearlyTable").innerHTML = renderTableYearly(yearlyRows);
    }

    main();
  </script>
</body>
</html>
