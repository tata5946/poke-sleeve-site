<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ä¾¡æ ¼æ¨ç§»</title>
  <meta name="description" content="ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ã®å¹´æ¬¡å¹³å‡ä¾¡æ ¼æ¨ç§»ã‚’æ²è¼‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ãƒˆã€‚å„ã‚¹ãƒªãƒ¼ãƒ–ã®ç›¸å ´å¤‰å‹•ã‚’ç¢ºèªã§ãã¾ã™ã€‚">
  <style>
    body { font-family: sans-serif; margin: 40px; }
    h1 { margin-bottom: 10px; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; padding:0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .title { font-weight: 800; font-size: 16px; margin-bottom: 6px; }
    .meta { font-size: 13px; color: #666; }
    a.btn { display:inline-block; margin-top: 10px; text-decoration:none; border:1px solid #333; padding:8px 10px; border-radius:8px; color:#111; }

    .small { font-size: 12px; color:#666; }
    .error { background:#fff3f3; border:1px solid #ffcccc; padding:12px; border-radius:10px; color:#b00020; margin: 12px 0; }

    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0 18px; }
    .controls select, .controls button { padding: 8px; }
    .controls label { font-size: 13px; color:#333; }
  </style>
</head>
<body>
  <h1>ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ä¾¡æ ¼æ¨ç§»</h1>

  <p><a href="./ranking.html">ğŸ“ˆ ä¾¡æ ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a></p>
  <p><a href="./growth.html">ğŸ”¥ é«˜é¨°ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a></p>
  <p><a href="./surge.html">ğŸš€ æ€¥ä¸Šæ˜‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a></p>

  <p>
    å½“ã‚µã‚¤ãƒˆã¯ã€ãƒã‚±ã‚«ã‚¹ãƒªãƒ¼ãƒ–ã®å¹´æ¬¡å¹³å‡ä¾¡æ ¼æ¨ç§»ã‚’ã¾ã¨ã‚ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚<br>
    å„ã‚¹ãƒªãƒ¼ãƒ–ã”ã¨ã®ç›¸å ´å¤‰å‹•ã‚’ä¸€è¦§ã§ç¢ºèªã§ãã¾ã™ã€‚
  </p>

  <input type="text" id="search" placeholder="ã‚¹ãƒªãƒ¼ãƒ–åã§æ¤œç´¢..." style="padding:8px; width:300px; margin-bottom:12px;">
  <p class="small">ãƒ‡ãƒ¼ã‚¿ï¼ˆdata.jsonï¼‰ã‚’æ›´æ–°ã™ã‚‹ã¨ä¸€è¦§ãŒè‡ªå‹•ã§å¢—ãˆã¾ã™ã€‚</p>

  <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆidã¯ã“ã‚Œ1ã¤ã ã‘ï¼‰ -->
  <div id="error" class="error" style="display:none;"></div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
  <div class="controls">
    <label>ç™ºå£²å¹´ï¼š
      <select id="releaseYear">
        <option value="">å…¨éƒ¨</option>
      </select>
    </label>

    <label>ã‚·ãƒªãƒ¼ã‚ºï¼š
      <select id="series">
        <option value="">å…¨éƒ¨</option>
      </select>
    </label>

    <label>ä¾¡æ ¼ã®å¹´ï¼š
      <select id="priceYear">
        <option value="">ï¼ˆå¹´ã‚’é¸æŠï¼‰</option>
      </select>
    </label>

    <label>ä¾¡æ ¼å¸¯ï¼š
      <select id="priceBand">
        <option value="">å…¨éƒ¨</option>
        <option value="0-999">ã€œ999å††</option>
        <option value="1000-1999">1,000ã€œ1,999å††</option>
        <option value="2000-2999">2,000ã€œ2,999å††</option>
        <option value="3000-4999">3,000ã€œ4,999å††</option>
        <option value="5000-99999999">5,000å††ã€œ</option>
      </select>
    </label>

    <button id="clear" type="button">ã‚¯ãƒªã‚¢</button>
  </div>

  <div id="list" class="grid"></div>

  <script>
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showError(msg) {
      const el = document.getElementById("error");
      if (!el) return;
      el.style.display = "block";
      el.textContent = msg;
    }

    function hideError() {
      const el = document.getElementById("error");
      if (!el) return;
      el.style.display = "none";
      el.textContent = "";
    }

    async function loadData() {
      const res = await fetch("./data.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(`data.json ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰`);
      return await res.json();
    }

    function uniq(arr) {
      return Array.from(new Set(arr.filter(v => v != null && String(v).trim() !== "")));
    }

    function parseBand(v) {
      if (!v) return null;
      const [a, b] = v.split("-").map(Number);
      if (!Number.isFinite(a) || !Number.isFinite(b)) return null;
      return { min: a, max: b };
    }

    async function main() {
      const list = document.getElementById("list");
      const searchInput = document.getElementById("search");

      const releaseYearSel = document.getElementById("releaseYear");
      const seriesSel = document.getElementById("series");
      const priceYearSel = document.getElementById("priceYear");
      const priceBandSel = document.getElementById("priceBand");
      const clearBtn = document.getElementById("clear");

      let data;
      try {
        data = await loadData();
      } catch (e) {
        showError(e.message + " / data.json ãŒãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      hideError();

      const sleeves = Array.isArray(data.sleeves) ? data.sleeves : [];

      // ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã®ç”Ÿæˆ
      const releaseYears = uniq(sleeves.map(s => s.releaseYear)).sort((a, b) => a - b);
      const seriesList = uniq(sleeves.map(s => s.series)).sort();
      const allPriceYears = uniq(sleeves.flatMap(s => Object.keys(s.pricesByYear || {}))).sort();

      for (const y of releaseYears) {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        releaseYearSel.appendChild(opt);
      }

      for (const ser of seriesList) {
        const opt = document.createElement("option");
        opt.value = ser;
        opt.textContent = ser;
        seriesSel.appendChild(opt);
      }

      for (const y of allPriceYears) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        priceYearSel.appendChild(opt);
      }

      // åˆæœŸã¯æœ€æ–°å¹´
      if (allPriceYears.length > 0) {
        priceYearSel.value = allPriceYears[allPriceYears.length - 1];
      }

      function getPriceForYear(s, year) {
        if (!year) return null;
        const v = (s.pricesByYear || {})[year];
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function render() {
        const kw = searchInput.value.trim().toLowerCase();
        const releaseYear = releaseYearSel.value;
        const series = seriesSel.value;
        const priceYear = priceYearSel.value;
        const band = parseBand(priceBandSel.value);

        list.innerHTML = "";

        // â‘  ã¾ãšãƒ•ã‚£ãƒ«ã‚¿
        const filtered = sleeves.filter(s => {
          if (kw && !String(s.name || "").toLowerCase().includes(kw)) return false;
          if (releaseYear && String(s.releaseYear) !== releaseYear) return false;
          if (series && String(s.series || "") !== series) return false;

          if (band) {
            const p = getPriceForYear(s, priceYear);
            if (p == null) return false;
            if (p < band.min || p > band.max) return false;
          }
          return true;
        });

        // â‘¡ ãã®å¾Œã‚½ãƒ¼ãƒˆï¼ˆé¸æŠå¹´ã®ä¾¡æ ¼ãŒé«˜ã„é †ï¼‰
        filtered.sort((a, b) => {
          const pa = getPriceForYear(a, priceYear) ?? -1;
          const pb = getPriceForYear(b, priceYear) ?? -1;
          return pb - pa;
        });

        // â‘¢ è¡¨ç¤º
        if (filtered.length === 0) {
          list.innerHTML = `<div class="card"><div class="title">è©²å½“ãªã—</div><div class="meta">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¹ãƒªãƒ¼ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
          return;
        }

        for (const s of filtered) {
          const div = document.createElement("div");
          div.className = "card";

          const p = getPriceForYear(s, priceYear);
          const priceText = (p == null) ? "â€”" : `${p.toLocaleString()}å††ï¼ˆ${priceYear}ï¼‰`;

          div.innerHTML = `
            <div class="title">${escapeHtml(s.name ?? "")}</div>
            <div class="meta">ç™ºå£²å¹´ï¼š${escapeHtml(s.releaseYear ?? "")} / ${escapeHtml(s.condition ?? "")} / ${escapeHtml(s.series ?? "")}</div>
            <div class="meta">è¡¨ç¤ºä¾¡æ ¼ï¼š${escapeHtml(priceText)}</div>
            <a class="btn" href="./detail.html?id=${encodeURIComponent(s.id ?? "")}">ä¾¡æ ¼æ¨ç§»ã‚’è¦‹ã‚‹ â†’</a>
          `;
          list.appendChild(div);
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆ
      searchInput.addEventListener("input", render);
      releaseYearSel.addEventListener("change", render);
      seriesSel.addEventListener("change", render);
      priceYearSel.addEventListener("change", render);
      priceBandSel.addEventListener("change", render);

      clearBtn.addEventListener("click", () => {
        searchInput.value = "";
        releaseYearSel.value = "";
        seriesSel.value = "";
        priceBandSel.value = "";
        if (allPriceYears.length > 0) priceYearSel.value = allPriceYears[allPriceYears.length - 1];
        render();
      });

      render();
    }

    main();
  </script>
</body>
</html>
